<% layout("/layouts/boilerplate") %>

<style>
  .listing-container { padding: 2rem 1rem 4rem; }
  .listing-card { border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.15); overflow: hidden; margin-bottom: 2rem; }
  .show-img { height: 26rem; object-fit: cover; }
  .card-body p { margin-bottom: 0.4rem; }
  .btns { gap: 1rem; }
  .btns a, .btns button { border-radius: 25px; padding: 0.5rem 1.4rem; }
  .review-form { background: #f8f9fa; border-radius: 14px; padding: 1.8rem; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 2rem; }
  .review-card { background: #fff; border-radius: 14px; padding: 1.2rem; margin-bottom: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  #map { height: 350px; width: 100%; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); margin-top: 1rem; }
  .error-msg { color: #dc3545; font-size: 0.9rem; margin-top: 0.5rem; }
  @media (max-width: 768px) { .show-img { height: 18rem; } }
</style>

<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  const listing = <%- JSON.stringify(listing || {}) %>;
  const coordinates = listing.geometry?.coordinates || null;
</script>

<div class="container listing-container">

  <!-- Title -->
  <div class="text-center mb-4">
    <h2><%= listing.title %></h2>
    <% if (listing.owner) { %>
      <p class="text-muted">Owned by <i><%= listing.owner.username %></i></p>
    <% } %>
  </div>

  <!-- Listing Card -->
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card listing-card">
        <img src="<%= listing.image?.url %>" class="card-img-top show-img" />
        <div class="card-body">
          <p><b>Price:</b> â‚¹ <%= listing.price?.toLocaleString("en-IN") %></p>
          <p><b>Country:</b> <%= listing.country %></p>
          <p><b>Location:</b> <%= listing.location %></p>
          <p><b>Description:</b> <%= listing.description %></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit/Delete -->
  <% if (currUser && listing.owner && listing.owner._id.equals(currUser._id)) { %>
    <div class="d-flex justify-content-center btns mb-4">
      <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">Edit</a>
      <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
        <button class="btn btn-danger">Delete</button>
      </form>
    </div>
  <% } %>

  <!-- Review Form -->
  <% if (currUser) { %>
    <div class="row justify-content-center">
      <div class="col-md-8 review-form">
        <h4 class="mb-3">Leave a Review</h4>

        <!-- Flash Error -->
        <% if (error && error.length) { %>
          <div class="alert alert-danger"><%= error %></div>
        <% } %>

        <form 
          action="/listings/<%= listing._id %>/reviews" 
          method="POST" 
          onsubmit="return validateRating()"
        >
          <div class="mb-3">
            <label class="form-label">Rating</label>
            <fieldset class="starability-slot">
              <% for (let i = 1; i <= 5; i++) { %>
                <input type="radio" id="rate-<%= i %>" name="review[rating]" value="<%= i %>" />
                <label for="rate-<%= i %>"><%= i %> star</label>
              <% } %>
            </fieldset>
            <div id="ratingError" class="error-msg d-none">
              Please select a rating before submitting.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Comment</label>
            <textarea name="review[comment]" class="form-control" rows="4" required></textarea>
          </div>

          <button class="btn btn-outline-dark">Submit</button>
        </form>
      </div>
    </div>
  <% } %>

  <!-- Reviews -->
  <% if (listing.reviews && listing.reviews.length) { %>
    <div class="row justify-content-center mt-4">
      <div class="col-md-8">
        <h4 class="mb-3">All Reviews</h4>
        <% listing.reviews.forEach(review => { %>
          <div class="review-card">
            <h6>@<%= review.author.username %></h6>
            <p class="starability-result" data-rating="<%= review.rating %>"></p>
            <p><%= review.comment %></p>

            <% if (currUser && review.author._id.equals(currUser._id)) { %>
              <form 
                method="POST" 
                action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
              >
                <button class="btn btn-sm btn-danger">Delete</button>
              </form>
            <% } %>
          </div>
        <% }) %>
      </div>
    </div>
  <% } %>

  <!-- Map -->
  <div class="row justify-content-center mt-4">
    <div class="col-md-8">
      <h4>Where you'll be</h4>
      <div id="map"></div>
    </div>
  </div>

</div>

<script>
  function validateRating() {
    const ratingSelected = document.querySelector(
      'input[name="review[rating]"]:checked'
    );
    const errorDiv = document.getElementById("ratingError");

    if (!ratingSelected) {
      errorDiv.classList.remove("d-none");
      return false;
    }

    errorDiv.classList.add("d-none");
    return true;
  }
</script>

<script src="/js/map.js"></script>
